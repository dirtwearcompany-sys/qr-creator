<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #151515;
            --bg-tertiary: #1f1f1f;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #00ff88;
            --accent-dim: #00aa55;
            --border: #2a2a2a;
            --danger: #ff4444;
            --warning: #ffaa00;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Mono', monospace; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; overflow-x: hidden; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; background: radial-gradient(circle at 20% 50%, rgba(0,255,136,0.05) 0%, transparent 50%), radial-gradient(circle at 80% 50%, rgba(0,255,136,0.03) 0%, transparent 50%); }
        .auth-box { background: var(--bg-secondary); border: 2px solid var(--border); padding: 3rem; max-width: 400px; width: 100%; position: relative; }
        .auth-box::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; height: 2px; background: linear-gradient(90deg, var(--accent), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0%,100%{opacity:.5}50%{opacity:1} }
        h1 { font-family: 'JetBrains Mono', monospace; font-size: 2rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 2px; }
        .subtitle { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 1px; }
        .input-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); }
        input { width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); font-family: 'Space Mono', monospace; font-size: 0.9rem; transition: all 0.3s; }
        input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,255,136,0.1); }
        button { width: 100%; padding: 0.75rem; background: var(--accent); color: var(--bg-primary); border: none; font-family: 'JetBrains Mono', monospace; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: all 0.3s; }
        button:hover { background: var(--accent-dim); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,255,136,0.3); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .error-message { color: var(--danger); font-size: 0.85rem; margin-top: 1rem; padding: 0.5rem; background: rgba(255,68,68,0.1); border-left: 2px solid var(--danger); }
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.active { display: block; }
        .header { background: var(--bg-secondary); border-bottom: 2px solid var(--border); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.5rem; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-email { font-size: 0.85rem; color: var(--text-secondary); }
        .btn-logout { padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border); color: var(--text-primary); width: auto; }
        .btn-logout:hover { background: var(--bg-tertiary); border-color: var(--accent); transform: none; box-shadow: none; }
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .style-selector { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .style-option { flex: 1; min-width: 140px; padding: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border); color: var(--text-secondary); cursor: pointer; text-align: center; transition: all 0.3s; font-family: 'Space Mono', monospace; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; width: auto; }
        .style-option:hover { border-color: var(--accent); color: var(--text-primary); background: var(--bg-secondary); transform: none; box-shadow: none; }
        .style-option.selected { border-color: var(--accent); background: rgba(0,255,136,0.08); color: var(--accent); transform: none; box-shadow: 0 0 12px rgba(0,255,136,0.2); }
        .style-option .style-icon { font-size: 2rem; line-height: 1; }
        .style-option .style-name { font-weight: 700; }
        .style-option .style-desc { font-size: 0.7rem; color: var(--text-secondary); line-height: 1.3; }
        .controls { display: grid; gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border: 1px solid var(--border); }
        .input-row { display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: end; }
        .btn-create { padding: 0.75rem 1.5rem; width: auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); padding: 1.5rem; position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent); transform: scaleX(0); transition: transform 0.5s; }
        .stat-card:hover::after { transform: scaleX(1); }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 2rem; font-weight: 700; color: var(--accent); }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .qr-card { background: var(--bg-secondary); border: 1px solid var(--border); padding: 1.5rem; transition: all 0.3s; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        .qr-card:hover { border-color: var(--accent); transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,255,136,0.1); }
        .qr-card.locked { border-color: var(--warning); }
        .qr-style-badge { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; padding: 0.2rem 0.5rem; background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); color: var(--accent); margin-bottom: 0.75rem; }
        .qr-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .qr-label { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.1rem; word-break: break-word; }
        .lock-icon { cursor: pointer; font-size: 1.2rem; transition: all 0.3s; }
        .lock-icon:hover { color: var(--accent); transform: rotate(15deg); }
        .qr-image-container { background: white; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: center; align-items: center; min-height: 160px; }
        .qr-image-container img { max-width: 100%; height: auto; display: block; }
        .qr-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-left: 2px solid var(--accent); }
        .qr-stat { display: flex; flex-direction: column; }
        .qr-stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .qr-stat-value { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.2rem; color: var(--accent); }
        .qr-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .btn-action { padding: 0.5rem; font-size: 0.85rem; width: 100%; }
        .btn-delete { background: var(--danger); }
        .btn-delete:hover { background: #cc0000; box-shadow: none; }
        .btn-download { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-download:hover { background: var(--accent); color: var(--bg-primary); box-shadow: none; }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.3; }
        .scan-container { display: none; min-height: 100vh; padding: 2rem; align-items: center; justify-content: center; flex-direction: column; }
        .scan-container.active { display: flex; }
        .scan-result { background: var(--bg-secondary); border: 2px solid var(--border); padding: 3rem; max-width: 500px; width: 100%; text-align: center; }
        .scan-success { font-size: 4rem; color: var(--accent); margin-bottom: 1rem; }
        .scan-success.loading { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.1)} }
        .scan-label { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; margin-bottom: 1rem; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .generating-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.82); z-index: 999; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; font-family: 'JetBrains Mono', monospace; color: var(--accent); font-size: 1.1rem; letter-spacing: 2px; text-align: center; padding: 2rem; }
        .generating-overlay.active { display: flex; }
        .generating-overlay .big-spin { width: 60px; height: 60px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .input-row { grid-template-columns: 1fr; }
            .qr-grid { grid-template-columns: 1fr; }
            .style-selector { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="generating-overlay" id="generatingOverlay">
    <div class="big-spin"></div>
    <div id="generatingText">GENERATING QR CODE...</div>
</div>

<div id="authContainer" class="auth-container">
    <div class="auth-box">
        <h1>QR Manager</h1>
        <p class="subtitle">Secure Access Portal</p>
        <div class="input-group">
            <label for="authEmail">Email</label>
            <input type="email" id="authEmail" placeholder="user@example.com">
        </div>
        <div class="input-group">
            <label for="authPassword">Password</label>
            <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button id="btnLogin">Login</button>
        <p style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border);color:var(--text-secondary);font-size:0.85rem;text-align:center;">
            New signups require admin approval.<br>Contact the administrator for access.
        </p>
        <div id="authError" class="error-message" style="display:none;"></div>
    </div>
</div>

<div id="dashboard" class="dashboard">
    <div class="header">
        <h1>QR Code Manager</h1>
        <div class="user-info">
            <span class="user-email" id="userEmail"></span>
            <button class="btn-logout" id="btnLogout">Logout</button>
        </div>
    </div>
    <div class="main-content">
        <div class="stats">
            <div class="stat-card"><div class="stat-label">Total QR Codes</div><div class="stat-value" id="totalCodes">0</div></div>
            <div class="stat-card"><div class="stat-label">Total Scans</div><div class="stat-value" id="totalScans">0</div></div>
            <div class="stat-card"><div class="stat-label">Locked Codes</div><div class="stat-value" id="lockedCodes">0</div></div>
        </div>
        <div class="controls">
            <div>
                <label style="margin-bottom:0.75rem;display:block;">QR Code Style</label>
                <div class="style-selector">
                    <button class="style-option selected" data-style="regular" onclick="selectStyle('regular',this)">
                        <span class="style-icon">‚¨õ</span>
                        <span class="style-name">Regular</span>
                        <span class="style-desc">Classic square QR code</span>
                    </button>
                    <button class="style-option" data-style="footprint" onclick="selectStyle('footprint',this)">
                        <span class="style-icon">ü¶ï</span>
                        <span class="style-name">Dino Tracks</span>
                        <span class="style-desc">Modules as dino footprints</span>
                    </button>
                    <button class="style-option" data-style="dinosaur" onclick="selectStyle('dinosaur',this)">
                        <span class="style-icon">ü¶ñ</span>
                        <span class="style-name">Dino Shape</span>
                        <span class="style-desc">QR inside a T-Rex frame</span>
                    </button>
                    <button class="style-option" data-style="footshape" onclick="selectStyle('footshape',this)">
                        <span class="style-icon">üêæ</span>
                        <span class="style-name">Foot Shape</span>
                        <span class="style-desc">Entire QR shaped as one giant footprint</span>
                    </button>
                </div>
            </div>
            <div class="input-row">
                <div class="input-group" style="margin:0;">
                    <label for="qrUrl">Target URL</label>
                    <input type="text" id="qrUrl" placeholder="https://example.com">
                </div>
                <div class="input-group" style="margin:0;">
                    <label for="qrLabel">Label</label>
                    <input type="text" id="qrLabel" placeholder="My QR Code">
                </div>
                <button class="btn-create" id="btnCreate">Create QR</button>
            </div>
        </div>
        <div id="qrGrid" class="qr-grid">
            <div class="empty-state"><div class="empty-state-icon">‚äû</div><p>No QR codes yet. Create your first one above.</p></div>
        </div>
    </div>
</div>

<div id="scanContainer" class="scan-container">
    <div class="scan-result">
        <div class="scan-success loading" id="scanSuccessIcon">‚è≥</div>
        <div class="scan-label" id="scanLabel">Processing scan...</div>
        <p style="margin:1rem 0;color:var(--text-secondary);font-size:0.9rem;">Redirecting...</p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// QRMatrix stub ‚Äî kept to avoid reference errors
var QRMatrix = (function() {
    var EXP = new Array(512), LOG = new Array(256);
    (function(){
        var x = 1;
        for (var i = 0; i < 255; i++) {
            EXP[i] = x; LOG[x] = i;
            x <<= 1; if (x & 256) x ^= 0x11d;
        }
        for (var i = 255; i < 512; i++) EXP[i] = EXP[i - 255];
    })();
    function gfMul(a, b) { return (a === 0 || b === 0) ? 0 : EXP[LOG[a] + LOG[b]]; }
    function rsEncode(data, ecCount) {
        var gen = [1];
        for (var i = 0; i < ecCount; i++) {
            var next = [1, EXP[i]];
            var prod = new Array(gen.length + next.length - 1).fill(0);
            for (var j = 0; j < gen.length; j++)
                for (var k = 0; k < next.length; k++)
                    prod[j + k] ^= gfMul(gen[j], next[k]);
            gen = prod;
        }
        var msg = data.slice();
        for (var i = 0; i < ecCount; i++) msg.push(0);
        for (var i = 0; i < data.length; i++) {
            var coef = msg[i];
            if (coef !== 0)
                for (var j = 0; j < gen.length; j++)
                    msg[i + j] ^= gfMul(gen[j], coef);
        }
        return msg.slice(data.length);
    }
    function encodeData(text) {
        var bytes = [];
        for (var i = 0; i < text.length; i++) {
            var code = text.charCodeAt(i);
            if (code > 0x7f) {
                if (code < 0x800) { bytes.push(0xc0 | (code >> 6)); bytes.push(0x80 | (code & 0x3f)); }
                else { bytes.push(0xe0 | (code >> 12)); bytes.push(0x80 | ((code >> 6) & 0x3f)); bytes.push(0x80 | (code & 0x3f)); }
            } else { bytes.push(code); }
        }
        return bytes;
    }
    return { encode: function() { return { matrix: [], size: 0 }; } };
})();

// ================================================================
// STYLE SELECTION
// ================================================================
window._selectedStyle = 'regular';
window.selectStyle = function(style, el) {
    window._selectedStyle = style;
    document.querySelectorAll('.style-option').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
};

// ================================================================
// GENERATE REGULAR QR (external API)
// ================================================================
window.generateRegularQR = function(scanUrl) {
    return Promise.resolve('https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(scanUrl));
};

// ================================================================
// GENERATE FOOTPRINT QR
// Each dark data module is drawn as a dinosaur footprint shape
// matching the reference photo: wide heel pad at bottom,
// center toe pointing up, left toe sweeping upper-left,
// right toe angling upper-right.
// ================================================================
window.generateFootprintQR = function(scanUrl) {
    return new Promise(function(resolve) {
        var SAMPLE_SIZE = 4500;
        var div = document.createElement('div');
        div.style.cssText = 'position:fixed;left:-9999px;top:0;background:white;';
        document.body.appendChild(div);

        new QRCode(div, {
            text: scanUrl,
            width: SAMPLE_SIZE,
            height: SAMPLE_SIZE,
            correctLevel: QRCode.CorrectLevel.H
        });

        setTimeout(function() {
            var srcCanvas = div.querySelector('canvas');
            if (!srcCanvas) {
                document.body.removeChild(div);
                resolve(window.generateRegularQR(scanUrl));
                return;
            }

            var ctx = srcCanvas.getContext('2d');
            var W = srcCanvas.width;
            var pixels = ctx.getImageData(0, 0, W, W).data;

            function isDarkAt(px, py) {
                var ix = Math.round(Math.min(Math.max(px, 0), W-1));
                var iy = Math.round(Math.min(Math.max(py, 0), W-1));
                return pixels[(iy * W + ix) * 4] < 128;
            }

            var quietLeft = 0;
            for (var x = 0; x < W/2; x++) {
                var foundInCol = false;
                for (var y = W*0.1; y < W*0.9; y++) { if (isDarkAt(x, y)) { foundInCol = true; break; } }
                if (foundInCol) { quietLeft = x; break; }
            }
            var quietTop = 0;
            for (var y = 0; y < W/2; y++) {
                var foundInRow = false;
                for (var x = W*0.1; x < W*0.9; x++) { if (isDarkAt(x, y)) { foundInRow = true; break; } }
                if (foundInRow) { quietTop = y; break; }
            }
            var quietRight = W;
            for (var x = W-1; x > W/2; x--) {
                var foundInCol = false;
                for (var y = W*0.1; y < W*0.9; y++) { if (isDarkAt(x, y)) { foundInCol = true; break; } }
                if (foundInCol) { quietRight = x; break; }
            }
            var darkEnd = quietLeft;
            for (var x = quietLeft; x < W; x++) {
                if (isDarkAt(x, quietTop + 2)) darkEnd = x;
                else break;
            }
            var modPx = (darkEnd - quietLeft + 1) / 7;
            var qrSpan = quietRight - quietLeft + modPx;
            var N = Math.round(qrSpan / modPx);

            var matrix = [];
            for (var r = 0; r < N; r++) {
                matrix[r] = [];
                for (var c = 0; c < N; c++) {
                    var sampleX = quietLeft + (c + 0.5) * modPx;
                    var sampleY = quietTop  + (r + 0.5) * modPx;
                    matrix[r][c] = isDarkAt(sampleX, sampleY);
                }
            }

            document.body.removeChild(div);

            var valid = matrix[0] && matrix[0][0] === true &&
                        matrix[0][N-1] === true &&
                        matrix[N-1] && matrix[N-1][0] === true;

            if (!valid || N < 21) {
                console.warn('Matrix read failed, falling back. N='+N);
                resolve(window.generateRegularQR(scanUrl));
                return;
            }

            // ‚îÄ‚îÄ FIX 1: Increased cell size from 24 to 28 for better scannability ‚îÄ‚îÄ
            var CELL  = 28;  // output pixels per module
            var QUIET = 4;   // quiet zone in modules
            var TOTAL = (N + QUIET * 2) * CELL;

            var outCanvas = document.createElement('canvas');
            outCanvas.width  = TOTAL;
            outCanvas.height = TOTAL;
            var octx = outCanvas.getContext('2d');

            octx.fillStyle = '#ffffff';
            octx.fillRect(0, 0, TOTAL, TOTAL);

            function ox(c) { return (QUIET + c) * CELL; }
            function oy(r) { return (QUIET + r) * CELL; }

            function isFinder(r, c) {
                if (r < 7 && c < 7) return true;
                if (r < 7 && c >= N-7) return true;
                if (r >= N-7 && c < 7) return true;
                return false;
            }
            function isSeparator(r, c) {
                if (r === 7 && c <= 7) return true;
                if (c === 7 && r <= 7) return true;
                if (r === 7 && c >= N-8) return true;
                if (c === N-8 && r <= 7) return true;
                if (r === N-8 && c <= 7) return true;
                if (c === 7 && r >= N-8) return true;
                return false;
            }
            function isTiming(r, c) { return (r === 6 || c === 6); }
            function isFormatInfo(r, c) {
                if (r === 8 && c <= 8) return true;
                if (r === 8 && c >= N-8) return true;
                if (c === 8 && r <= 8) return true;
                if (c === 8 && r >= N-8) return true;
                return false;
            }
            function isAlignment(r, c) {
                var brc = N - 7;
                return (Math.abs(r - brc) <= 2 && Math.abs(c - brc) <= 2);
            }
            function isStructural(r, c) {
                return isFinder(r,c) || isSeparator(r,c) || isTiming(r,c) ||
                       isFormatInfo(r,c) || isAlignment(r,c);
            }

            // Pass 1: structural zones as solid squares
            for (var r = 0; r < N; r++) {
                for (var c = 0; c < N; c++) {
                    if (!isStructural(r, c)) continue;
                    octx.fillStyle = matrix[r][c] ? '#000000' : '#ffffff';
                    octx.fillRect(ox(c), oy(r), CELL, CELL);
                }
            }

            // Pass 2: data modules as footprints
            for (var r = 0; r < N; r++) {
                for (var c = 0; c < N; c++) {
                    if (isStructural(r, c)) continue;
                    if (matrix[r][c]) {
                        drawFootprint(octx, ox(c), oy(r), CELL);
                    }
                }
            }

            resolve(outCanvas.toDataURL('image/png'));

        }, 800);
    });
};

// ================================================================
// DRAW A DINOSAUR FOOTPRINT matching the reference photo:
//   - Wide oval heel pad at bottom-center
//   - CENTER toe: longest, points nearly straight up (slight left lean)
//   - LEFT toe:   long, sweeps hard to upper-left (~50¬∞ from vertical)
//   - RIGHT toe:  medium, angles to upper-right (~40¬∞ from vertical)
//
// All parts overlap at the heel for a solid, recognizable shape.
// Dark area coverage ~70% of cell ensures reliable QR scanning.
// ================================================================
function drawFootprint(ctx, x, y, S) {
    ctx.save();

    // Clip to this cell so nothing bleeds into adjacent modules
    ctx.beginPath();
    ctx.rect(x, y, S, S);
    ctx.clip();

    ctx.fillStyle = '#000000';

    var cx = x + S * 0.50;

    // ‚îÄ‚îÄ HEEL PAD ‚îÄ‚îÄ wide oval sitting at bottom-center
    ctx.beginPath();
    ctx.ellipse(cx, y + S * 0.76, S * 0.32, S * 0.20, 0, 0, Math.PI * 2);
    ctx.fill();

    // ‚îÄ‚îÄ CENTER TOE ‚îÄ‚îÄ longest, nearly straight up, slight left lean
    ctx.beginPath();
    ctx.ellipse(cx - S*0.03, y + S*0.43, S * 0.095, S * 0.26, -0.10, 0, Math.PI * 2);
    ctx.fill();
    // Center claw tip
    ctx.beginPath();
    ctx.ellipse(cx - S*0.06, y + S*0.12, S * 0.058, S * 0.10, -0.20, 0, Math.PI * 2);
    ctx.fill();

    // ‚îÄ‚îÄ LEFT TOE ‚îÄ‚îÄ long, sweeps hard to upper-left (~50¬∞ from vertical)
    ctx.beginPath();
    ctx.ellipse(x + S*0.22, y + S*0.46, S * 0.085, S * 0.25, -0.90, 0, Math.PI * 2);
    ctx.fill();
    // Left claw tip
    ctx.beginPath();
    ctx.ellipse(x + S*0.065, y + S*0.20, S * 0.052, S * 0.095, -0.90, 0, Math.PI * 2);
    ctx.fill();

    // ‚îÄ‚îÄ RIGHT TOE ‚îÄ‚îÄ medium length, angles to upper-right (~40¬∞ from vertical)
    ctx.beginPath();
    ctx.ellipse(x + S*0.74, y + S*0.50, S * 0.085, S * 0.21, 0.70, 0, Math.PI * 2);
    ctx.fill();
    // Right claw tip
    ctx.beginPath();
    ctx.ellipse(x + S*0.895, y + S*0.28, S * 0.052, S * 0.085, 0.70, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
}

// ================================================================
// GENERATE FOOTSHAPE QR - entire QR shaped as one giant footprint
// ================================================================
window.FOOTPRINT_B64 = '/9j/4AAQSkZJRgABAg=='; // placeholder - not used in this path

window.generateFootshapeQR = function(scanUrl) {
    return new Promise(function(resolve) {
        // ‚îÄ‚îÄ Step 1: Sample the QR matrix at high resolution ‚îÄ‚îÄ
        var SAMPLE = 4100;
        var div = document.createElement('div');
        div.style.cssText = 'position:fixed;left:-9999px;top:0;background:white;';
        document.body.appendChild(div);
        new QRCode(div, { text: scanUrl, width: SAMPLE, height: SAMPLE, correctLevel: QRCode.CorrectLevel.H });

        setTimeout(function() {
            var src = div.querySelector('canvas');
            if (!src) { document.body.removeChild(div); resolve(window.generateRegularQR(scanUrl)); return; }
            document.body.removeChild(div);

            var sctx = src.getContext('2d');
            var SW = src.width;
            var spx = sctx.getImageData(0,0,SW,SW).data;
            function sd(x,y){
                x=Math.round(Math.min(Math.max(x,0),SW-1));
                y=Math.round(Math.min(Math.max(y,0),SW-1));
                return spx[(y*SW+x)*4]<128;
            }
            // Find QR grid boundaries
            var ql=0; outer1: for(var x=0;x<SW/2;x++) for(var y=SW*.1;y<SW*.9;y++) if(sd(x,y)){ql=x;break outer1;}
            var qt=0; outer2: for(var y=0;y<SW/2;y++) for(var x=SW*.1;x<SW*.9;x++) if(sd(x,y)){qt=y;break outer2;}
            var qr=SW-1; outer3: for(var x=SW-1;x>SW/2;x--) for(var y=SW*.1;y<SW*.9;y++) if(sd(x,y)){qr=x;break outer3;}
            var re=ql; for(var x=ql;x<SW;x++){if(sd(x,qt+1))re=x;else break;}
            var mp=(re-ql+1)/7;
            var N=Math.round((qr-ql+mp)/mp);
            if(N<21){resolve(window.generateRegularQR(scanUrl));return;}
            var mat=[];
            for(var r=0;r<N;r++){mat[r]=[];for(var c=0;c<N;c++) mat[r][c]=sd(ql+(c+.5)*mp, qt+(r+.5)*mp);}

            // ‚îÄ‚îÄ Step 2: Set up output canvas ‚îÄ‚îÄ
            // The footprint shape is TALLER than wide (roughly 1.3:1 height:width ratio
            // based on the reference image). We place the QR grid in the LOWER portion
            // (the "heel" area), which is the widest part. The toes fan upward.
            //
            // Canvas layout (all coordinates are fractions of canvasW):
            //   - Canvas is square: canvasW x canvasW
            //   - QR grid occupies a region we call the "heel zone"
            //   - The footprint extends ABOVE the QR grid with toes
            //
            // Key insight: the QR grid must be FULLY INSIDE the heel of the footprint.
            // We make the canvas tall enough that toes have room above the QR grid.

            var CELL = 16;   // pixels per QR module
            var QUIET = 2;   // quiet zone in modules

            // QR grid pixel dimensions
            var qrPx = (N + QUIET*2) * CELL;

            // Canvas is wider to give the footprint natural proportions.
            // The heel (containing the QR) sits in the bottom 62% of the canvas.
            // Toes occupy the top 38% + some overlap into the heel.
            var HPAD = Math.round(qrPx * 0.18);  // horizontal padding each side
            var canvasW = qrPx + HPAD * 2;
            var canvasH = Math.round(canvasW * 1.42); // footprint height:width ~1.42

            var out = document.createElement('canvas');
            out.width = canvasW;
            out.height = canvasH;
            var ctx = out.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvasW, canvasH);

            // QR grid top-left corner: horizontally centered, bottom-aligned with some margin
            var qrLeft = HPAD + QUIET * CELL;
            var qrTop  = canvasH - qrPx - Math.round(CELL * 2.5); // 2.5 module gap from bottom

            function ox(c){ return qrLeft + c * CELL; }
            function oy(r){ return qrTop  + r * CELL; }

            // ‚îÄ‚îÄ Step 3: Build the footprint Path2D ‚îÄ‚îÄ
            //
            // The reference image shows (when oriented naturally):
            //   - A large rounded HEEL PAD at the bottom-center
            //   - LEFT TOE:   longest, sweeps hard to upper-left
            //   - CENTER TOE: second longest, points mostly upward
            //   - RIGHT TOE:  slightly shorter, angles upper-right
            //
            // We define the path in absolute canvas pixels.
            // The heel wraps around the QR grid. Coordinates are designed so
            // the entire QR bounding box (including quiet zone) is inside.
            //
            // We work in fractions of canvasW (horizontal) and canvasH (vertical).
            function P(fx, fy){ return [fx * canvasW, fy * canvasH]; }

            // Heel pad: wide oval occupying bottom ~38% of canvas, full width
            // The three toes fan upward from the top of the heel pad (~y=0.62)

            var p = new Path2D();

            // Start at bottom-center of heel
            p.moveTo(...P(0.50, 0.97));

            // ‚îÄ‚îÄ Bottom-right curve of heel ‚îÄ‚îÄ
            p.bezierCurveTo(...P(0.72,0.97), ...P(0.88,0.93), ...P(0.90,0.83));
            p.bezierCurveTo(...P(0.92,0.74), ...P(0.86,0.66), ...P(0.78,0.63));

            // ‚îÄ‚îÄ RIGHT TOE (angles upper-right, medium length) ‚îÄ‚îÄ
            // Base of right toe connects from right side of heel top
            p.bezierCurveTo(...P(0.84,0.60), ...P(0.88,0.54), ...P(0.87,0.46));
            p.bezierCurveTo(...P(0.86,0.38), ...P(0.82,0.33), ...P(0.80,0.28));
            // Tip of right toe
            p.bezierCurveTo(...P(0.79,0.24), ...P(0.78,0.20), ...P(0.79,0.17));
            p.bezierCurveTo(...P(0.80,0.14), ...P(0.82,0.13), ...P(0.83,0.15));
            p.bezierCurveTo(...P(0.84,0.17), ...P(0.84,0.21), ...P(0.83,0.26));
            // Back down inner edge of right toe
            p.bezierCurveTo(...P(0.82,0.31), ...P(0.80,0.37), ...P(0.79,0.44));
            p.bezierCurveTo(...P(0.78,0.50), ...P(0.76,0.55), ...P(0.72,0.58));

            // ‚îÄ‚îÄ CENTER TOE (points mostly upward, slightly left) ‚îÄ‚îÄ
            p.bezierCurveTo(...P(0.68,0.57), ...P(0.64,0.53), ...P(0.62,0.46));
            p.bezierCurveTo(...P(0.60,0.38), ...P(0.59,0.28), ...P(0.58,0.20));
            // Tip of center toe
            p.bezierCurveTo(...P(0.57,0.13), ...P(0.56,0.07), ...P(0.57,0.04));
            p.bezierCurveTo(...P(0.58,0.01), ...P(0.60,0.00), ...P(0.62,0.01));
            p.bezierCurveTo(...P(0.64,0.02), ...P(0.65,0.06), ...P(0.65,0.11));
            // Back down inner edge of center toe
            p.bezierCurveTo(...P(0.65,0.18), ...P(0.64,0.27), ...P(0.63,0.35));
            p.bezierCurveTo(...P(0.62,0.42), ...P(0.61,0.49), ...P(0.59,0.54));

            // ‚îÄ‚îÄ LEFT TOE (sweeps hard upper-left, longest toe) ‚îÄ‚îÄ
            p.bezierCurveTo(...P(0.56,0.54), ...P(0.52,0.52), ...P(0.49,0.47));
            p.bezierCurveTo(...P(0.46,0.41), ...P(0.43,0.33), ...P(0.39,0.25));
            p.bezierCurveTo(...P(0.35,0.17), ...P(0.30,0.10), ...P(0.26,0.06));
            // Tip of left toe (upper-left corner area)
            p.bezierCurveTo(...P(0.23,0.03), ...P(0.20,0.02), ...P(0.18,0.04));
            p.bezierCurveTo(...P(0.16,0.06), ...P(0.16,0.10), ...P(0.18,0.14));
            p.bezierCurveTo(...P(0.20,0.18), ...P(0.24,0.22), ...P(0.28,0.28));
            // Back down inner edge of left toe
            p.bezierCurveTo(...P(0.32,0.34), ...P(0.36,0.40), ...P(0.38,0.47));
            p.bezierCurveTo(...P(0.40,0.52), ...P(0.40,0.58), ...P(0.38,0.63));

            // ‚îÄ‚îÄ Left side of heel ‚îÄ‚îÄ
            p.bezierCurveTo(...P(0.33,0.67), ...P(0.25,0.70), ...P(0.18,0.76));
            p.bezierCurveTo(...P(0.11,0.82), ...P(0.08,0.89), ...P(0.10,0.93));
            p.bezierCurveTo(...P(0.13,0.97), ...P(0.30,0.99), ...P(0.50,0.97));

            p.closePath();

            // ‚îÄ‚îÄ Step 4: Build pixel mask for inside-footprint test ‚îÄ‚îÄ
            var mc = document.createElement('canvas');
            mc.width = canvasW; mc.height = canvasH;
            var mctx = mc.getContext('2d');
            mctx.fillStyle = '#000';
            mctx.fill(p);
            var mpxa = mctx.getImageData(0, 0, canvasW, canvasH).data;
            function inFoot(px, py){
                var ix = Math.round(Math.min(Math.max(px, 0), canvasW-1));
                var iy = Math.round(Math.min(Math.max(py, 0), canvasH-1));
                return mpxa[(iy * canvasW + ix) * 4 + 3] > 64;
            }

            // ‚îÄ‚îÄ Step 5: Draw footprint silhouette background ‚îÄ‚îÄ
            ctx.fillStyle = '#e8e8e8';
            ctx.fill(p);
            // Subtle inner highlight
            ctx.fillStyle = 'rgba(255,255,255,0.18)';
            ctx.fill(p);

            // ‚îÄ‚îÄ Step 6: Clip ALL drawing to the footprint shape ‚îÄ‚îÄ
            // This guarantees nothing ‚Äî including finder squares ‚Äî can escape
            ctx.save();
            ctx.clip(p);

            // Structural zone helpers
            function isFinder(r,c){ return (r<7&&c<7)||(r<7&&c>=N-7)||(r>=N-7&&c<7); }
            function isSep(r,c){
                if(r===7&&c<=7||c===7&&r<=7) return true;
                if(r===7&&c>=N-8||c===N-8&&r<=7) return true;
                if(r===N-8&&c<=7||c===7&&r>=N-8) return true;
                return false;
            }
            function isTiming(r,c){ return r===6||c===6; }
            function isFmt(r,c){ return (r===8&&(c<=8||c>=N-8))||(c===8&&(r<=8||r>=N-8)); }
            function isAlign(r,c){ var a=N-7; return Math.abs(r-a)<=2&&Math.abs(c-a)<=2; }
            function isStruct(r,c){ return isFinder(r,c)||isSep(r,c)||isTiming(r,c)||isFmt(r,c)||isAlign(r,c); }

            // Draw a white backing rectangle for the QR area so it reads cleanly
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(ox(0) - CELL, oy(0) - CELL, N*CELL + CELL*2, N*CELL + CELL*2);

            // Draw ALL modules ‚Äî structural as solid squares, data as solid squares
            // Both get drawn inside the clip; finder squares can't exceed the footprint
            for(var r=0;r<N;r++){
                for(var c=0;c<N;c++){
                    if(isStruct(r,c)){
                        ctx.fillStyle = mat[r][c] ? '#000000' : '#ffffff';
                        ctx.fillRect(ox(c), oy(r), CELL, CELL);
                    } else if(mat[r][c]){
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(ox(c), oy(r), CELL, CELL);
                    }
                }
            }

            ctx.restore(); // end clip

            // ‚îÄ‚îÄ Step 7: Draw outline of footprint on top ‚îÄ‚îÄ
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.stroke(p);

            resolve(out.toDataURL('image/png'));
        }, 800);
    });
};

// ================================================================
// GENERATE DINO SHAPE QR - QR embedded in T-Rex illustration
// ================================================================
window.generateDinosaurQR = function(scanUrl) {
    return new Promise(function(resolve) {
        var div = document.createElement('div');
        div.style.cssText = 'position:fixed;left:-9999px;top:0;background:white;';
        document.body.appendChild(div);

        new QRCode(div, { text: scanUrl, width: 230, height: 230, correctLevel: QRCode.CorrectLevel.H });

        setTimeout(function() {
            var src = div.querySelector('canvas');
            if (!src) { document.body.removeChild(div); resolve(null); return; }

            var C = 560;
            var out = document.createElement('canvas');
            out.width = C; out.height = C;
            var ctx = out.getContext('2d');

            ctx.fillStyle = '#f8fff4';
            ctx.fillRect(0, 0, C, C);

            function s(v) { return v * C; }

            var skin1 = '#2d5a1b', skin2 = '#3d7a25', skin3 = '#5aaa38', skin4 = '#8dd460';
            var belly = '#b8e890', mouth = '#8b1a1a', tooth = '#fffde7', tongue = '#cc4444';
            var claw = '#1a2a0a', eye1 = '#ffcc00';

            // TAIL
            ctx.fillStyle = skin1;
            ctx.beginPath();
            ctx.moveTo(s(0.03), s(0.57));
            ctx.bezierCurveTo(s(0.07),s(0.50),s(0.14),s(0.46),s(0.23),s(0.44));
            ctx.bezierCurveTo(s(0.28),s(0.43),s(0.32),s(0.44),s(0.34),s(0.46));
            ctx.bezierCurveTo(s(0.31),s(0.51),s(0.26),s(0.56),s(0.20),s(0.60));
            ctx.bezierCurveTo(s(0.13),s(0.65),s(0.07),s(0.65),s(0.04),s(0.63));
            ctx.closePath(); ctx.fill();
            ctx.fillStyle = skin2;
            ctx.beginPath();
            ctx.moveTo(s(0.06),s(0.52)); ctx.bezierCurveTo(s(0.11),s(0.48),s(0.18),s(0.46),s(0.24),s(0.46));
            ctx.bezierCurveTo(s(0.20),s(0.48),s(0.13),s(0.51),s(0.08),s(0.55)); ctx.closePath(); ctx.fill();

            // BACK LEG
            ctx.fillStyle = skin1;
            ctx.beginPath();
            ctx.moveTo(s(0.28),s(0.57)); ctx.bezierCurveTo(s(0.25),s(0.63),s(0.24),s(0.70),s(0.25),s(0.76));
            ctx.bezierCurveTo(s(0.26),s(0.80),s(0.29),s(0.82),s(0.32),s(0.82));
            ctx.bezierCurveTo(s(0.35),s(0.82),s(0.37),s(0.80),s(0.38),s(0.76));
            ctx.bezierCurveTo(s(0.39),s(0.71),s(0.37),s(0.63),s(0.34),s(0.59));
            ctx.bezierCurveTo(s(0.31),s(0.56),s(0.29),s(0.55),s(0.28),s(0.57)); ctx.fill();
            ctx.beginPath();
            ctx.moveTo(s(0.26),s(0.80)); ctx.bezierCurveTo(s(0.25),s(0.86),s(0.24),s(0.91),s(0.23),s(0.95));
            ctx.bezierCurveTo(s(0.22),s(0.97),s(0.23),s(0.975),s(0.26),s(0.975));
            ctx.bezierCurveTo(s(0.29),s(0.975),s(0.32),s(0.96),s(0.33),s(0.92));
            ctx.bezierCurveTo(s(0.34),s(0.88),s(0.33),s(0.83),s(0.32),s(0.80));
            ctx.bezierCurveTo(s(0.30),s(0.78),s(0.27),s(0.78),s(0.26),s(0.80)); ctx.fill();
            ctx.fillStyle = skin1;
            ctx.beginPath(); ctx.ellipse(s(0.235),s(0.972),s(0.062),s(0.022),-0.15,0,Math.PI*2); ctx.fill();
            for(var i=0;i<3;i++){ctx.fillStyle=claw;ctx.beginPath();ctx.ellipse(s(0.20)+(i*s(0.040)),s(0.982),s(0.011),s(0.018),(i-1)*0.25,0,Math.PI*2);ctx.fill();}

            // MAIN BODY
            ctx.fillStyle = skin2;
            ctx.beginPath();
            ctx.moveTo(s(0.22),s(0.44));
            ctx.bezierCurveTo(s(0.30),s(0.38),s(0.40),s(0.34),s(0.52),s(0.30));
            ctx.bezierCurveTo(s(0.60),s(0.27),s(0.66),s(0.26),s(0.70),s(0.28));
            ctx.bezierCurveTo(s(0.74),s(0.30),s(0.76),s(0.34),s(0.76),s(0.38));
            ctx.bezierCurveTo(s(0.75),s(0.44),s(0.72),s(0.50),s(0.66),s(0.55));
            ctx.bezierCurveTo(s(0.59),s(0.60),s(0.50),s(0.62),s(0.42),s(0.62));
            ctx.bezierCurveTo(s(0.35),s(0.62),s(0.28),s(0.60),s(0.24),s(0.57));
            ctx.bezierCurveTo(s(0.21),s(0.54),s(0.20),s(0.50),s(0.22),s(0.44)); ctx.fill();
            ctx.fillStyle = skin3;
            ctx.beginPath();
            ctx.moveTo(s(0.24),s(0.42)); ctx.bezierCurveTo(s(0.33),s(0.36),s(0.44),s(0.32),s(0.56),s(0.29));
            ctx.bezierCurveTo(s(0.62),s(0.28),s(0.67),s(0.28),s(0.69),s(0.29));
            ctx.bezierCurveTo(s(0.65),s(0.28),s(0.58),s(0.29),s(0.50),s(0.31));
            ctx.bezierCurveTo(s(0.40),s(0.34),s(0.30),s(0.38),s(0.24),s(0.42)); ctx.fill();
            ctx.fillStyle = belly;
            ctx.beginPath();
            ctx.moveTo(s(0.30),s(0.60)); ctx.bezierCurveTo(s(0.38),s(0.63),s(0.50),s(0.65),s(0.58),s(0.62));
            ctx.bezierCurveTo(s(0.64),s(0.60),s(0.67),s(0.56),s(0.68),s(0.52));
            ctx.bezierCurveTo(s(0.65),s(0.57),s(0.59),s(0.61),s(0.52),s(0.62));
            ctx.bezierCurveTo(s(0.45),s(0.63),s(0.38),s(0.62),s(0.30),s(0.60)); ctx.fill();

            // Dorsal spines
            ctx.fillStyle = skin1;
            var spines=[[0.23,0.42,0.024],[0.30,0.39,0.030],[0.38,0.36,0.034],[0.46,0.32,0.032],[0.53,0.29,0.028],[0.59,0.28,0.022],[0.64,0.27,0.018]];
            for(var i=0;i<spines.length;i++){var sp=spines[i];ctx.beginPath();ctx.moveTo(s(sp[0]-0.011),s(sp[1]));ctx.lineTo(s(sp[0]),s(sp[1]-sp[2]));ctx.lineTo(s(sp[0]+0.011),s(sp[1]));ctx.fill();}

            // Scale texture
            ctx.fillStyle='rgba(0,0,0,0.10)';
            var scales=[[0.35,0.44],[0.40,0.42],[0.45,0.40],[0.50,0.39],[0.55,0.38],[0.60,0.37],[0.37,0.49],[0.42,0.47],[0.47,0.45],[0.52,0.44],[0.57,0.42],[0.39,0.53],[0.44,0.51],[0.49,0.49],[0.54,0.48]];
            for(var i=0;i<scales.length;i++){ctx.beginPath();ctx.arc(s(scales[i][0]),s(scales[i][1]),s(0.0065),0,Math.PI*2);ctx.fill();}

            // TINY ARM
            ctx.fillStyle=skin1;
            ctx.beginPath();
            ctx.moveTo(s(0.69),s(0.40)); ctx.bezierCurveTo(s(0.72),s(0.43),s(0.73),s(0.47),s(0.71),s(0.51));
            ctx.bezierCurveTo(s(0.70),s(0.53),s(0.68),s(0.54),s(0.67),s(0.52));
            ctx.bezierCurveTo(s(0.66),s(0.50),s(0.66),s(0.46),s(0.67),s(0.43));
            ctx.bezierCurveTo(s(0.68),s(0.41),s(0.69),s(0.40),s(0.69),s(0.40)); ctx.fill();
            for(var i=0;i<2;i++){ctx.fillStyle=claw;ctx.beginPath();ctx.ellipse(s(0.685)+i*s(0.016),s(0.535),s(0.008),s(0.013),i*0.35-0.2,0,Math.PI*2);ctx.fill();}

            // FRONT LEG
            ctx.fillStyle=skin2;
            ctx.beginPath();
            ctx.moveTo(s(0.56),s(0.59)); ctx.bezierCurveTo(s(0.54),s(0.64),s(0.52),s(0.70),s(0.53),s(0.76));
            ctx.bezierCurveTo(s(0.54),s(0.80),s(0.57),s(0.82),s(0.60),s(0.82));
            ctx.bezierCurveTo(s(0.63),s(0.82),s(0.65),s(0.80),s(0.66),s(0.76));
            ctx.bezierCurveTo(s(0.67),s(0.71),s(0.65),s(0.65),s(0.63),s(0.61));
            ctx.bezierCurveTo(s(0.61),s(0.58),s(0.57),s(0.57),s(0.56),s(0.59)); ctx.fill();
            ctx.fillStyle=skin3;
            ctx.beginPath(); ctx.ellipse(s(0.59),s(0.76),s(0.024),s(0.020),0.2,0,Math.PI*2); ctx.fill();
            ctx.fillStyle=skin1;
            ctx.beginPath();
            ctx.moveTo(s(0.55),s(0.80)); ctx.bezierCurveTo(s(0.54),s(0.87),s(0.53),s(0.91),s(0.52),s(0.95));
            ctx.bezierCurveTo(s(0.51),s(0.975),s(0.51),s(0.978),s(0.54),s(0.978));
            ctx.bezierCurveTo(s(0.57),s(0.978),s(0.61),s(0.965),s(0.62),s(0.92));
            ctx.bezierCurveTo(s(0.63),s(0.87),s(0.63),s(0.84),s(0.61),s(0.80));
            ctx.bezierCurveTo(s(0.60),s(0.78),s(0.56),s(0.78),s(0.55),s(0.80)); ctx.fill();
            ctx.fillStyle=skin1;
            ctx.beginPath(); ctx.ellipse(s(0.52),s(0.974),s(0.070),s(0.025),-0.15,0,Math.PI*2); ctx.fill();
            for(var i=0;i<3;i++){ctx.fillStyle=claw;ctx.beginPath();ctx.ellipse(s(0.49)+i*s(0.048),s(0.983),s(0.013),s(0.021),(i-1)*0.28,0,Math.PI*2);ctx.fill();}

            // NECK
            ctx.fillStyle=skin2;
            ctx.beginPath();
            ctx.moveTo(s(0.68),s(0.28)); ctx.bezierCurveTo(s(0.70),s(0.23),s(0.72),s(0.18),s(0.74),s(0.14));
            ctx.bezierCurveTo(s(0.76),s(0.11),s(0.79),s(0.10),s(0.82),s(0.10));
            ctx.bezierCurveTo(s(0.84),s(0.11),s(0.85),s(0.13),s(0.84),s(0.16));
            ctx.bezierCurveTo(s(0.83),s(0.20),s(0.80),s(0.24),s(0.77),s(0.27));
            ctx.bezierCurveTo(s(0.74),s(0.30),s(0.71),s(0.32),s(0.69),s(0.32));
            ctx.bezierCurveTo(s(0.67),s(0.32),s(0.66),s(0.31),s(0.68),s(0.28)); ctx.fill();
            ctx.fillStyle=belly;
            ctx.beginPath();
            ctx.moveTo(s(0.70),s(0.31)); ctx.bezierCurveTo(s(0.72),s(0.26),s(0.74),s(0.21),s(0.76),s(0.17));
            ctx.bezierCurveTo(s(0.77),s(0.15),s(0.78),s(0.14),s(0.79),s(0.15));
            ctx.bezierCurveTo(s(0.78),s(0.19),s(0.76),s(0.24),s(0.74),s(0.28));
            ctx.bezierCurveTo(s(0.73),s(0.30),s(0.71),s(0.31),s(0.70),s(0.31)); ctx.fill();

            // HEAD
            ctx.fillStyle=skin2;
            ctx.beginPath();
            ctx.moveTo(s(0.76),s(0.10));
            ctx.bezierCurveTo(s(0.79),s(0.06),s(0.84),s(0.04),s(0.89),s(0.05));
            ctx.bezierCurveTo(s(0.94),s(0.06),s(0.97),s(0.09),s(0.975),s(0.13));
            ctx.bezierCurveTo(s(0.98),s(0.17),s(0.975),s(0.22),s(0.965),s(0.25));
            ctx.bezierCurveTo(s(0.955),s(0.28),s(0.935),s(0.30),s(0.91),s(0.30));
            ctx.bezierCurveTo(s(0.89),s(0.30),s(0.87),s(0.29),s(0.86),s(0.28));
            ctx.bezierCurveTo(s(0.83),s(0.27),s(0.80),s(0.27),s(0.78),s(0.29));
            ctx.bezierCurveTo(s(0.76),s(0.31),s(0.74),s(0.31),s(0.73),s(0.29));
            ctx.bezierCurveTo(s(0.72),s(0.27),s(0.72),s(0.23),s(0.72),s(0.19));
            ctx.bezierCurveTo(s(0.72),s(0.14),s(0.74),s(0.11),s(0.76),s(0.10)); ctx.fill();
            ctx.fillStyle=skin3;
            ctx.beginPath();
            ctx.moveTo(s(0.78),s(0.08)); ctx.bezierCurveTo(s(0.83),s(0.05),s(0.88),s(0.05),s(0.92),s(0.07));
            ctx.bezierCurveTo(s(0.94),s(0.08),s(0.95),s(0.10),s(0.94),s(0.11));
            ctx.bezierCurveTo(s(0.90),s(0.08),s(0.85),s(0.07),s(0.80),s(0.09)); ctx.fill();
            ctx.fillStyle=skin1;
            var headRidge=[[0.80,0.07,0.012],[0.85,0.055,0.013],[0.89,0.055,0.012]];
            for(var i=0;i<headRidge.length;i++){var hr=headRidge[i];ctx.beginPath();ctx.moveTo(s(hr[0]-0.010),s(hr[1]));ctx.lineTo(s(hr[0]),s(hr[1]-hr[2]));ctx.lineTo(s(hr[0]+0.010),s(hr[1]));ctx.fill();}

            // MOUTH
            ctx.fillStyle=mouth;
            ctx.beginPath();
            ctx.moveTo(s(0.80),s(0.18)); ctx.bezierCurveTo(s(0.85),s(0.17),s(0.90),s(0.17),s(0.94),s(0.19));
            ctx.bezierCurveTo(s(0.96),s(0.20),s(0.965),s(0.23),s(0.96),s(0.25));
            ctx.bezierCurveTo(s(0.93),s(0.27),s(0.89),s(0.28),s(0.86),s(0.27));
            ctx.bezierCurveTo(s(0.83),s(0.26),s(0.81),s(0.24),s(0.80),s(0.22));
            ctx.bezierCurveTo(s(0.79),s(0.20),s(0.79),s(0.19),s(0.80),s(0.18)); ctx.fill();
            ctx.fillStyle=skin2;
            ctx.beginPath();
            ctx.moveTo(s(0.74),s(0.29)); ctx.bezierCurveTo(s(0.77),s(0.30),s(0.82),s(0.31),s(0.86),s(0.30));
            ctx.bezierCurveTo(s(0.90),s(0.29),s(0.93),s(0.28),s(0.94),s(0.29));
            ctx.bezierCurveTo(s(0.95),s(0.30),s(0.95),s(0.33),s(0.94),s(0.35));
            ctx.bezierCurveTo(s(0.92),s(0.37),s(0.88),s(0.38),s(0.85),s(0.37));
            ctx.bezierCurveTo(s(0.82),s(0.36),s(0.79),s(0.36),s(0.77),s(0.37));
            ctx.bezierCurveTo(s(0.75),s(0.38),s(0.73),s(0.37),s(0.72),s(0.35));
            ctx.bezierCurveTo(s(0.72),s(0.32),s(0.73),s(0.29),s(0.74),s(0.29)); ctx.fill();
            ctx.fillStyle=mouth;
            ctx.beginPath();
            ctx.moveTo(s(0.78),s(0.30)); ctx.bezierCurveTo(s(0.83),s(0.30),s(0.88),s(0.29),s(0.92),s(0.30));
            ctx.bezierCurveTo(s(0.93),s(0.31),s(0.94),s(0.33),s(0.93),s(0.34));
            ctx.bezierCurveTo(s(0.90),s(0.35),s(0.86),s(0.35),s(0.83),s(0.34));
            ctx.bezierCurveTo(s(0.80),s(0.33),s(0.78),s(0.32),s(0.78),s(0.30)); ctx.fill();

            // TEETH
            ctx.fillStyle=tooth;
            var upT=[0.82,0.855,0.885,0.912];
            for(var i=0;i<upT.length;i++){var tx=upT[i];ctx.beginPath();ctx.moveTo(s(tx),s(0.265));ctx.lineTo(s(tx+0.013),s(0.282));ctx.lineTo(s(tx+0.026),s(0.265));ctx.fill();}
            var loT=[0.83,0.860,0.890];
            for(var i=0;i<loT.length;i++){var tx=loT[i];ctx.beginPath();ctx.moveTo(s(tx),s(0.313));ctx.lineTo(s(tx+0.013),s(0.296));ctx.lineTo(s(tx+0.026),s(0.313));ctx.fill();}
            ctx.fillStyle=tongue;
            ctx.beginPath();
            ctx.moveTo(s(0.82),s(0.305)); ctx.bezierCurveTo(s(0.85),s(0.325),s(0.88),s(0.33),s(0.90),s(0.32));
            ctx.bezierCurveTo(s(0.88),s(0.305),s(0.85),s(0.295),s(0.82),s(0.305)); ctx.fill();

            // EYE
            ctx.fillStyle=skin1; ctx.beginPath(); ctx.ellipse(s(0.806),s(0.125),s(0.034),s(0.028),-0.2,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#ffffcc'; ctx.beginPath(); ctx.ellipse(s(0.808),s(0.123),s(0.024),s(0.020),-0.2,0,Math.PI*2); ctx.fill();
            ctx.fillStyle=eye1; ctx.beginPath(); ctx.ellipse(s(0.811),s(0.122),s(0.015),s(0.013),0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#111'; ctx.beginPath(); ctx.ellipse(s(0.812),s(0.122),s(0.005),s(0.012),0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.beginPath(); ctx.ellipse(s(0.817),s(0.116),s(0.005),s(0.004),0,0,Math.PI*2); ctx.fill();

            // NOSTRIL
            ctx.fillStyle=skin1; ctx.beginPath(); ctx.ellipse(s(0.955),s(0.115),s(0.011),s(0.008),0.5,0,Math.PI*2); ctx.fill();

            // QR CODE in torso
            var qrW=218, qrH=218, qrX=s(0.285), qrY=s(0.325);
            ctx.shadowColor='rgba(0,0,0,0.25)'; ctx.shadowBlur=10; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;
            ctx.fillStyle='#ffffff';
            ctx.beginPath(); ctx.roundRect(qrX-10,qrY-10,qrW+20,qrH+20,5); ctx.fill();
            ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
            ctx.drawImage(src, qrX, qrY, qrW, qrH);
            ctx.strokeStyle=skin1; ctx.lineWidth=2.5;
            ctx.beginPath(); ctx.roundRect(qrX-10,qrY-10,qrW+20,qrH+20,5); ctx.stroke();

            document.body.removeChild(div);
            resolve(out.toDataURL('image/png'));
        }, 500);
    });
};

</script>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, set, onValue, remove, update, push, serverTimestamp, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyD4UGL6xY4WaUctzhBrY0_0aisBYsY5RYE",
        authDomain: "trails-qr-tracker.firebaseapp.com",
        databaseURL: "https://trails-qr-tracker-default-rtdb.firebaseio.com",
        projectId: "trails-qr-tracker",
        storageBucket: "trails-qr-tracker.firebasestorage.app",
        messagingSenderId: "712760332585",
        appId: "1:712760332585:web:318373bb1359360de16738",
        measurementId: "G-0XXHDT6ZHQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const scanIdParam = urlParams.get('scan');
    const userIdParam = urlParams.get('uid');
    if (scanIdParam && userIdParam) {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('scanContainer').classList.add('active');
    }

    let currentUser = null;
    let qrCodes = {};

    const authContainer = document.getElementById('authContainer');
    const dashboard = document.getElementById('dashboard');
    const scanContainer = document.getElementById('scanContainer');
    const generatingOverlay = document.getElementById('generatingOverlay');
    const generatingText = document.getElementById('generatingText');

    onAuthStateChanged(auth, user => {
        const p = new URLSearchParams(window.location.search);
        const sid = p.get('scan'), uid = p.get('uid');
        if (sid && uid) { handlePublicScan(uid, sid); return; }
        if (user) { currentUser = user; document.getElementById('userEmail').textContent = user.email; showDashboard(); loadQRCodes(); }
        else { currentUser = null; showAuth(); }
    });

    document.getElementById('btnLogin').addEventListener('click', async () => {
        const email = document.getElementById('authEmail').value.trim();
        const password = document.getElementById('authPassword').value;
        if (!email || !password) { showError('Please enter email and password'); return; }
        const btn = document.getElementById('btnLogin');
        btn.disabled = true; btn.innerHTML = '<span class="loading"></span>';
        try { await signInWithEmailAndPassword(auth, email, password); }
        catch(e) { showError(getErrMsg(e.code)); }
        finally { btn.disabled = false; btn.textContent = 'Login'; }
    });

    document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));
    document.getElementById('authPassword').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('btnLogin').click(); });

    function showError(msg) { const el = document.getElementById('authError'); el.textContent = msg; el.style.display = 'block'; setTimeout(() => el.style.display='none', 5000); }
    function getErrMsg(code) { return {'auth/invalid-email':'Invalid email','auth/user-disabled':'Account disabled','auth/user-not-found':'No account found','auth/wrong-password':'Incorrect password','auth/network-request-failed':'Network error','auth/too-many-requests':'Too many attempts'}[code] || 'Authentication error'; }
    function showAuth() { authContainer.style.display='flex'; dashboard.classList.remove('active'); scanContainer.classList.remove('active'); }
    function showDashboard() { authContainer.style.display='none'; dashboard.classList.add('active'); scanContainer.classList.remove('active'); }

    function loadQRCodes() {
        onValue(ref(db, `users/${currentUser.uid}/qrcodes`), snap => {
            qrCodes = snap.val() || {};
            renderQRCodes(); updateStats();
        });
    }

    document.getElementById('btnCreate').addEventListener('click', async () => {
        const url = document.getElementById('qrUrl').value.trim();
        const label = document.getElementById('qrLabel').value.trim();
        if (!url) { alert('Please enter a URL'); return; }
        if (!label) { alert('Please enter a label'); return; }

        const style = window._selectedStyle;
        const btn = document.getElementById('btnCreate');
        btn.disabled = true;
        const msgs = { regular:'GENERATING QR CODE...', footprint:'STAMPING DINO TRACKS...', dinosaur:'SUMMONING T-REX...', footshape:'SHAPING THE FOOTPRINT...' };
        generatingText.textContent = msgs[style] || 'GENERATING...';
        generatingOverlay.classList.add('active');

        try {
            const newRef = push(ref(db, `users/${currentUser.uid}/qrcodes`));
            const qrId = newRef.key;
            const scanUrl = `${window.location.origin}${window.location.pathname}?scan=${qrId}&uid=${currentUser.uid}`;

            let qrImageUrl;
            if (style === 'regular')        qrImageUrl = await window.generateRegularQR(scanUrl);
            else if (style === 'footprint')  qrImageUrl = await window.generateFootprintQR(scanUrl);
            else if (style === 'dinosaur')   qrImageUrl = await window.generateDinosaurQR(scanUrl);
            else if (style === 'footshape')  qrImageUrl = await window.generateFootshapeQR(scanUrl);

            if (!qrImageUrl) throw new Error('Generation returned null');

            await set(newRef, { id:qrId, label, url, qrImageUrl, qrStyle:style, scanCount:0, locked:false, createdAt:serverTimestamp(), lastScanned:null });
            document.getElementById('qrUrl').value = '';
            document.getElementById('qrLabel').value = '';
        } catch(e) {
            console.error(e);
            alert('Failed to create QR code: ' + e.message);
        } finally {
            btn.disabled = false;
            generatingOverlay.classList.remove('active');
        }
    });

    const styleLabels = { regular:'‚¨õ Regular', footprint:'ü¶ï Dino Tracks', dinosaur:'ü¶ñ Dino Shape', footshape:'üêæ Foot Shape' };

    function renderQRCodes() {
        const codes = Object.values(qrCodes);
        const grid = document.getElementById('qrGrid');
        if (!codes.length) { grid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚äû</div><p>No QR codes yet. Create your first one above.</p></div>`; return; }
        codes.sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
        grid.innerHTML = codes.map(code => {
            const scanUrl = `${window.location.origin}${window.location.pathname}?scan=${code.id}&uid=${currentUser.uid}`;
            const lastScanned = code.lastScanned ? new Date(code.lastScanned).toLocaleString() : 'Never';
            return `
                <div class="qr-card ${code.locked?'locked':''}" data-id="${code.id}">
                    <div class="qr-style-badge">${styleLabels[code.qrStyle]||'‚¨õ Regular'}</div>
                    <div class="qr-header">
                        <div class="qr-label">${esc(code.label)}</div>
                        <div class="lock-icon" onclick="toggleLock('${code.id}')">${code.locked?'üîí':'üîì'}</div>
                    </div>
                    <div class="qr-image-container">
                        <img src="${code.qrImageUrl}" alt="${esc(code.label)}" style="max-width:100%;height:auto;">
                    </div>
                    <div class="qr-stats">
                        <div class="qr-stat"><div class="qr-stat-label">Scans</div><div class="qr-stat-value">${code.scanCount||0}</div></div>
                        <div class="qr-stat"><div class="qr-stat-label">Last Scan</div><div class="qr-stat-value" style="font-size:0.75rem;">${lastScanned==='Never'?lastScanned:lastScanned.split(',')[0]}</div></div>
                    </div>
                    <div style="margin-bottom:1rem;padding:0.75rem;background:var(--bg-tertiary);font-size:0.75rem;word-break:break-all;">
                        <div style="color:var(--text-secondary);margin-bottom:0.25rem;">SCAN URL:</div>
                        <a href="${scanUrl}" target="_blank" style="color:var(--accent);text-decoration:none;">${scanUrl}</a>
                    </div>
                    <div class="qr-actions">
                        <button class="btn-action btn-download" onclick="downloadQR('${code.id}')">Download</button>
                        <button class="btn-action btn-delete" onclick="deleteQR('${code.id}')" ${code.locked?'disabled':''}>${code.locked?'Locked':'Delete'}</button>
                    </div>
                </div>`;
        }).join('');
    }

    function updateStats() {
        const codes = Object.values(qrCodes);
        document.getElementById('totalCodes').textContent = codes.length;
        document.getElementById('totalScans').textContent = codes.reduce((s,c)=>s+(c.scanCount||0),0);
        document.getElementById('lockedCodes').textContent = codes.filter(c=>c.locked).length;
    }

    window.toggleLock = async id => {
        const code = qrCodes[id]; if (!code) return;
        try { await update(ref(db,`users/${currentUser.uid}/qrcodes/${id}`),{locked:!code.locked}); }
        catch(e) { alert('Failed to toggle lock'); }
    };

    window.deleteQR = async id => {
        const code = qrCodes[id]; if (!code) return;
        if (code.locked) { alert('Unlock first.'); return; }
        if (!confirm(`Delete "${code.label}"?`)) return;
        try { await remove(ref(db,`users/${currentUser.uid}/qrcodes/${id}`)); }
        catch(e) { alert('Failed to delete'); }
    };

    window.downloadQR = async id => {
        const code = qrCodes[id]; if (!code) return;
        try {
            const res = await fetch(code.qrImageUrl);
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${code.label.replace(/[^a-z0-9]/gi,'_').toLowerCase()}_qr.png`;
            document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); document.body.removeChild(a);
        } catch(e) { alert('Download failed'); }
    };

    function esc(t) { return t.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    async function handlePublicScan(userId, qrId) {
        authContainer.style.display='none'; dashboard.classList.remove('active'); scanContainer.classList.add('active');
        const iconEl = document.getElementById('scanSuccessIcon');
        try {
            const qrRef = ref(db, `users/${userId}/qrcodes/${qrId}`);
            const snap = await get(qrRef);
            if (!snap.exists()) { iconEl.classList.remove('loading'); iconEl.textContent='‚úó'; document.getElementById('scanLabel').textContent='QR Code Not Found'; return; }
            const qrData = snap.val();
            await update(qrRef, { scanCount:(qrData.scanCount||0)+1, lastScanned:Date.now() });
            iconEl.classList.remove('loading'); iconEl.textContent='‚úì';
            document.getElementById('scanLabel').textContent = qrData.label;
            setTimeout(() => { window.location.href = qrData.url; }, 1000);
        } catch(e) {
            iconEl.classList.remove('loading'); iconEl.textContent='‚úó';
            document.getElementById('scanLabel').textContent='Error Processing Scan';
        }
    }
</script>
</body>
</html>
